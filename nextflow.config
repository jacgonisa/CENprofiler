/*
========================================================================================
    CENprofiler Nextflow Configuration
========================================================================================
*/

// Global default params
params {

    // ===== REQUIRED INPUTS =====
    input                   = null  // Input FASTA (genome or reads)
    reference_monomers      = null  // Representative monomers FASTA
    family_assignments      = null  // Family classification TSV
    outdir                  = './results'
    mode                    = 'auto' // Mode: 'genome', 'reads', or 'auto' (auto-detect from --alignment)

    // ===== READ MODE WITH BAM (AUTO-DETECTED) =====
    alignment               = null  // BAM/SAM file (triggers read mode with indel analysis)
    reference_genome        = null  // Reference genome (required when --alignment provided)
    annotation_dir          = null  // Genomic annotations directory (centromeres, rDNA, etc.)
    sample_name             = 'sample'  // Sample name for output files

    // ===== FASTAN PARAMETERS =====
    period_min              = 160   // Minimum tandem period (for CEN178: ~178bp)
    period_max              = 200   // Maximum tandem period
    fastan_threads          = 8     // Threads for FasTAN
    fastan_bin              = '/home/jg2070/bin/FasTAN'
    tanbed_bin              = '/home/jg2070/alntools/tanbed'

    // ===== CLASSIFICATION PARAMETERS =====
    min_identity            = 70    // Minimum alignment identity (%)
    minimap2_threads        = 4     // Threads for minimap2
    min_monomer_length      = 150   // Minimum monomer length to keep
    max_monomer_length      = 210   // Maximum monomer length to keep

    // ===== GENOME MODE: HOR DETECTION =====
    min_copies              = 3     // Minimum HOR copies (pattern repeats ≥3 times)
    min_monomers            = 3     // Minimum monomers per HOR unit (≥3 monomers)
    max_pattern_length      = 20    // Maximum monomers in HOR pattern
    max_gap                 = 500   // Maximum gap between consecutive monomers (bp)
    large_dup_threshold     = 40    // Large duplication threshold (kb)
    hor_min_purity          = 0.9   // Minimum HOR purity score (0-1, default: 0.9)
    hor_min_score           = 50    // Minimum HOR quality score (0-100, default: 50)

    // ===== READ MODE: INDEL ANALYSIS =====
    min_indel_size          = 100   // Minimum indel size to extract reads (bp)
    min_array_size          = 5     // Minimum array size (monomers)
    max_indel_size          = 10000 // Maximum indel size to analyze (bp)

    // ===== ADVANCED VISUALIZATIONS =====
    analyze_deletions       = true  // Extract and classify monomers from deletions in reference
    generate_ribbon_plots   = true  // Generate ribbon plots showing satellite remodelling
    n_ribbon_plots          = 5     // Number of ribbon plots to generate (top reads with indels)

    // ===== REPORTING =====
    chromosome_aware        = true  // Generate chromosome-level statistics
    top_arrays              = 10    // Number of top arrays to visualize in detail
    top_patterns            = 20    // Number of top patterns to show in plots

    // ===== HELP =====
    help                    = false

    // ===== EXECUTION =====
    max_memory              = '128.GB'
    max_cpus                = 16
    max_time                = '48.h'
}

// Process-specific resource requirements
process {

    // Default resources
    cpus   = 1
    memory = 4.GB
    time   = 4.h

    // Process-specific settings
    withName: FASTAN {
        cpus   = params.fastan_threads
        memory = 16.GB
        time   = 12.h
    }

    withName: EXTRACT_MONOMERS {
        memory = 8.GB
        time   = 4.h
    }

    withName: CLASSIFY_MONOMERS {
        cpus   = params.minimap2_threads
        memory = 16.GB
        time   = 8.h
    }

    withName: DETECT_HORS {
        memory = 32.GB
        time   = 12.h
    }

    withName: LOAD_GENOMIC_REGIONS {
        memory = 1.GB
        time   = 10.m
    }

    withName: EXTRACT_READS_FROM_BAM {
        memory = 32.GB
        time   = 24.h
        cpus   = 4
    }

    withName: ANALYZE_INDELS {
        memory = 16.GB
        time   = 8.h
    }

    withName: GENERATE_REPORTS {
        memory = 16.GB
        time   = 4.h
    }

    withName: ANALYZE_DELETION_MONOMERS {
        memory = 16.GB
        time   = 12.h
        cpus   = 4
    }

    withName: COMPREHENSIVE_READ_PLOTS {
        memory = 8.GB
        time   = 2.h
    }

    withName: RIBBON_PLOTS {
        memory = 12.GB
        time   = 6.h
    }
}

// Execution profiles
profiles {

    local {
        process.executor = 'local'
        process.cpus = 8
    }

    cluster {
        process.executor = 'slurm'
        process.queue = 'batch'
        process.clusterOptions = '--qos=normal'
    }

    debug {
        cleanup = false
        process.beforeScript = 'echo $HOSTNAME'
    }
}

// Manifest
manifest {
    name            = 'CENprofiler'
    author          = 'Your Name'
    homePage        = 'https://github.com/yourusername/CENprofiler'
    description     = 'Centromeric satellite and HOR analysis pipeline'
    mainScript      = 'main.nf'
    nextflowVersion = '>=21.10.0'
    version         = '1.0.0'
}

// Report options
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline.html"
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report.html"
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace.txt"
}

dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}
